<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
		"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Fluid.js Demo</title>
		<meta charset="UTF-8" />
		<link type="text/css" rel="Stylesheet" href="demo.css" media="all" />
		<script type="text/JavaScript" src="http://code.jquery.com/jquery-2.1.0.min.js"></script>
		<script type="text/JavaScript" src="fluid.js"></script>
		<script type="text/template" id="body-tmplt">
			<div class="wrapper">
				<h1>Fluid.js Demo</h1>
				<div class="Models">
					<h2>Models (ish)</h2>
					<p>Edit the name/color of the views here, or add/remove them</p>
					<div class="header item">
						<p class="name">Name</p>
						<p class="color">Text Color</p>
						<p class="bg">Background Color</p>
					</div>
					<div class="items">
						[[models]]
					</div>
					<a class="new">+ Add new</a>
				</div>
				<div class="Views">
					<h2>Views (ish)</h2>
					<p>Below the views are rendered.  You can also drag them around using the icon</p>
					<div class="items"> 
						[[views]]
					</div>
				</div>
			</div>
		</script>
		<script type="text/template" id="model-tmplt">
			<div class={{class}} style={{style}} modelIndex={{modelIndex}}>
				<a class="delete"></a>
				<div class="name">
					<input type="text" value={{name}}></input>
				</div>
				<div class="color">
					<input maxlength=6 type="text" value={{color}}></input>
				</div>
				<div class="bg">
					<input maxlength=6 type="text" value={{bg}}></input>
				</div>
			</div>
		</script>
		<script type="text/template" id="view-tmplt">
			<div class={{class}} style={{style}} modelIndex={{modelIndex}}>
				<span class="name">{{name}}</span>
				<a class="drag"></a>
			</div>
		</script>
		<script type="text/JavaScript">
			var items = new Fluid.model([{
				index: 0, name: "Steve J.", color: "FFFFFF", bg: "1E1E1E"
			}, {
				index: 1, name: "Bill G.", color: "FFFFFF", bg: "56C5FF"
			}, {
				index: 2, name: "Jeff B.", color: "FFFFFF", bg: "FF9900"
			}, {
				index: 3, name: "Larry P.", color: "FFFFFF", bg: "DD4B39"
			}, {
				index: 4, name: "Mark Z.", color: "FFFFFF", bg: "3B5998"
			}, {
				index: 5, name: "Amy Q.", color: "FFFFFF", bg: "FF6699"
			}]);
			var BodyView = Fluid.compileView({
				template: $("#body-tmplt").html(),
				calc: function(items) {
					var models = [];
					var views = [];
					for(var i = 0; i < items.length; i++)
						if(items[i] != null) {
							models.push(new ModelView(i, items[i].index,
								items[i].name, items[i].color,
								items[i].bg, items[i].hide));
							views.push(new ViewView(i, items[i].index,
								items[i].name, items[i].color,
								items[i].bg, items[i].hide,
								items[i].drag));
						}
					return {models: models, views: views};
				},
				setControls: function(init, $el) {
					if(init) $el.find(".new").click(function() {
						var itms = items.get();
						var cnt = 0;
						for(var i = 0; i < itms.length; i++)
							if((itms[i] != null) && !itms[i].hide)
								cnt++;
						itms.push({
							index: cnt,
							name: "",
							color: "FFFFFF",
							bg: "000000",
						});
						items.alert();
					});
				}
			});
			var ModelView = Fluid.compileView({
				template: $("#model-tmplt").html(),
				calc: function(modelIndex, index, name, color, bg, hide) {
					var klass = "item";
					if(hide)
						klass += " hidden";
					var style = "top: "+(23*index)+"px";
					return {class: klass, style: style, name: name,
							color: color, bg: bg, modelIndex: modelIndex};
				},
				setControls: function(init, $el) {
					if(init) {
						$el.find(".delete").click(function() {
							var i = parseInt(
										$(this).parent().attr("modelIndex"));
							var itms = items.get();
							itms[i].hide = true;
							i = itms[i].index;
							for(var j = 0; j < itms.length; j++)
								if(itms[j].index > i)
									itms[j].index--;
							items.alert();
						});
						function key() {
							var $this = $(this).parent().parent();
							var item = items.get()[
										parseInt($this.attr("modelIndex"))];
							item.name = $this.find(".name input").val();
							item.color = $this.find(".color input").val();
							item.bg = $this.find(".bg input").val();
							items.alert();
						};
						$el.find("input").keydown(key);
						$el.find("input").keyup(key);
						$el.find("input").keypress(key);
					}
				}
			});
			var ViewView = Fluid.compileView({
				template: $("#view-tmplt").html(),
				calc: function(modelIndex,index,name,color,bg,hide,drag) {
					var klass = "item";
					if(hide)
						klass += " hidden";
					if(drag != null)
						klass += " drag";
					drag = (((drag || 0) + 16) % 32 + 32) % 32 - 16
					var style = "top: "+(32*index+drag)+"px; color: #"+
								color+"; background: #"+bg;
					return {class: klass, style: style, name: name,
							modelIndex: modelIndex};
				},
				setControls: function(init, $el) {
					if(init) $el.find(".drag").mousedown(function(mEvent) {
						var itms = items.get();
						var item = itms[parseInt(
									$(this).parent().attr("modelIndex"))];
						var initY = mEvent.screenY;
						var initIndex = item.index;
						var maxIndex = 0;
						for(var i = 0; i < itms.length; i++)
							if(itms[i].index > maxIndex)
								maxIndex = itms[i].index;
						window.onmousemove = function(mEvent) {
							item.drag = mEvent.screenY - initY;
							var newIndex = Math.max(0, Math.min(maxIndex,
									initIndex + Math.round(item.drag/32)));
							if(newIndex < item.index) {
								for(var i = 0; i < itms.length; i++)
									if(	itms[i].index < item.index &&
										itms[i].index >= newIndex)
										itms[i].index++;
							} else if(newIndex > item.index)
								for(var i = 0; i < itms.length; i++)
									if(	itms[i].index > item.index &&
										itms[i].index <= newIndex)
										itms[i].index--;
							item.index = newIndex;
							items.alert();
						};
						window.onmouseup = function(mEvent) {
							window.onmousemove(mEvent);
							delete item.drag;
							items.alert();
							window.onmousemove = undefined;
							window.onmouseup = undefined;
						};
						window.onmousemove(mEvent);
					});
				}
			});
			window.onload = function() {
				Fluid.attachView($("body > div"), BodyView, items);
			};
		</script>
	</head>
	<body><div></div></body>
</html>
