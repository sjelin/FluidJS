var Fluid=function(t,e){"use strict";function r(){return this()}function n(t){return this(t)}function s(t){if(Object.defineProperty)try{Object.defineProperty(t,"val",{get:r,set:t.set})}catch(e){}}function o(e){var r=this,n=function(){return arguments.length>0?(r.alert(),arguments[0]):r()[e]};return t.extend(n,r),s(n),n}function a(){}function i(){return"_"+Math.random().toString(36).substr(2,6)+Math.random().toString(36).substr(2,6)}var l=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},p=function(t,e){return""==e?t:t.filter(e).add(t.find(e))};return e.newModel=function(t){listeners=[];var e=function(){return arguments.length>0&&(t=arguments[0],e.alert()),t};return e.listen=listeners.push.bind(listeners),e.alert-function(){for(var t=0;t<listeners.length;t++)listeners[t]()},e.get=r,e.set=n,e.sub=o,s(e),e},a.prototype.update=function(t){function e(t,e){i-=(new Date).getTime(),1==arguments.length?t.update():t.update(e),i+=(new Date).getTime()}if(this.state=(t||{}).state||this.state,!this.noMemoize&&(this.memoTime||0)<=(this.updateTime||0)/2){var r=(new Date).getTime(),n=JSON.stringify(this.state),s=n==this.oldStateHash,o=(new Date).getTime()-r;if(this.memoTime=(4*(this.memoTime||o)+o)/5,s)return;this.oldStateHash=n}else this.oldStateHash=void 0;var i=(new Date).getTime(),h=this.calc.apply(this,this.state),f=null!=this.vals;f||(this.$el=this.getFreshJQ(),this.vals={});for(var u in this.valCommands)if(h.hasOwnProperty(u))for(var m=h[u],v=this.valCommands[u],c=0;c<v.length;c++){var d=p(this.$el,"["+v[c]+"]");d.val()!=m&&d.val(m)}for(var u in this.attrCommands)if(h.hasOwnProperty(u)){var m=h[u];if(!f||this.vals[u]!=m)for(var y in this.attrCommands[u]){var d=p(this.$el,"["+y+"]");d.attr(this.attrCommands[u][y],m)}}for(var u in this.textCommands)if(h.hasOwnProperty(u)){var m=h[u];if(!f||this.vals[u]!=m)for(var g=this.textCommands[u],c=0;c<g.length;c++)p(this.$el,"["+g[c]+"]").text(m)}for(var u in this.viewCommands)if(h.hasOwnProperty(u)){var t=h[u],w=this.vals[u],d=p(this.$el,"#"+this.viewCommands[u]);if(l(t)){if(f)if(l(w)){for(var C=Math.min(t.length,w.length),c=0;C>c;c++)w[c].typeHash!=t[c].typeHash&&(C=c+1);for(;w.length>C;)w[w.length-1].$el.remove(),w.length--}else{if(w instanceof a)w.$el.remove();else if(w instanceof Object)for(var b in w)w[b]instanceof a&&w[b].$el.remove();w=[]}else w=[];for(var c=0;c<w.length;c++)e(w[c],t[c]),t[c]=w[c];for(var c=w.length;c<t.length;c++)e(t[c]),d.before(t[c].$el)}else if(t instanceof a){var $=!0;if(f)if(l(w))for(var c=0;c<w.length;c++)w[c].$el.remove();else if(w instanceof a)w.typeHash!=t.typeHash?w.$el.remove():($=!1,e(w,t),h[u]=w);else if(w instanceof Object)for(var b in w)w[b]instanceof a&&w[b].$el.remove();$&&(e(t),d.before(t.$el))}else if(t instanceof Object){if(f){if(l(w)){for(var c=0;c<w.length;c++)w[c].$el.remove();w={}}else if(w instanceof a)w[c].$el.remove(),w={};else if(w instanceof Object)for(var O in w)t[O]instanceof a||t[O].typeHash==w[O].typeHash||(w[O].$el.remove(),w[O]=void 0)}else w={};var T=[];for(var b in t)t[b]instanceof a&&T.push(b);t.__SORT__&&(t.__SORT__ instanceof Function?T.sort(t.__SORT__):T.sort());for(var c=T.length-1;c>=0;c--){var b=T[c];void 0==w[b]?(e(t[b]),(c+1==T.length?d:t[T[c+1]].$el).before(t[b].$el)):(e(w[b],t[b]),t[b]=w[b])}}}this.vals=h,this.listenTrgts=this.listeners instanceof Function?this.listeners():this.listeners;for(var j in this.listenTrgts)this.watch(j);f||this.addControls.apply(this,[this.$el].concat(this.state)),this.updateControls.apply(this,[f,this.$el].concat(this.state));var _=(new Date).getTime()-i;this.updateTime=(4*(this.updateTime||_)+_)/5},a.prototype.watch=function(t){function e(){var e=r.val();if(e!=n.prevValues[t]){var s=n.listenTrgts||[];l(s)||(s=[s]);for(var o=0;o<s.length;o++)s[o](e)}}if(!this.prevValues.hasOwnProperty(t)){var r=p(this.$el,t),n=this;n.prevValues[t]=r.val(),r.keypress(e),r.keydown(e),r.keyup(e),r.change(e)}},e.compileView=function(e){function r(){this.state=Array.prototype.slice.call(arguments,0)}return r.prototype=new a,r.prototype.calc=e.calc||function(){return new Object},r.prototype.addControls=e.addControls||function(){},r.prototype.updateControls=e.updateControls||function(){},r.prototype.listeners=e.listeners||{},r.prototype.noMemoize=!!e.noMemoize,r.prototype.typeHash=i(),r.prototype.prevValues={},r.prototype.valCommands={},r.prototype.attrCommands={},r.prototype.textCommands={},r.prototype.viewCommands={},e.template=e.template||"",e.template=e.template.replace(/value={{\s*\w+\s*}}/g,function(t){var e=t.substr(8,t.length-10).trim();null==r.prototype.valCommands[e]&&(r.prototype.valCommands[e]=[]),r.prototype.valCommands[e].push(i())}).replace(/[^\s]+={{\s*\w+\s*}}/g,function(t){var e=t.indexOf("="),n=t.substr(0,e),s=t.substr(e+3,t.length-e-5).trim(),o=i();return null==r.prototype.attrCommands[s]&&(r.prototype.attrCommands[s]={}),r.prototype.attrCommands[s][o]=n,o}).replace(/>\s*{{\s*\w+\s*}}\s*</g,function(t){var e=t.substr(1,t.length-2).trim();e=e.substr(2,e.length-4).trim();var n=i();return null==r.prototype.textCommands[e]&&(r.prototype.textCommands[e]=[]),r.prototype.textCommands[e].push(n)," "+n+"><"}).replace(/\[\[\s*\w+\s*\]\]/g,function(t){var e=t.substr(2,t.length-4).trim(),n=i();return r.prototype.viewCommands[e]=n,"<span id='"+n+"' style='display: none'></span>"}),r.prototype.getFreshJQ=function(){return t(e.template)},r},e.attachView=function(t,e){function r(){for(var t=[],r=0;r<s.length;r++)t.push(s[r].get());e.apply(this,t)}function n(){o.update(new r)}var s=Array.prototype.slice.call(arguments,2);r.prototype=e.prototype;var o=new r;o.update();for(var a=0;a<s.length;a++)s[a].listen(n);t.replaceWith(o.$el)},e}(void 0!=typeof jQuery?jQuery:void 0!=typeof require?require("jquery"):$,void 0==typeof module?new Object:module.exports);
