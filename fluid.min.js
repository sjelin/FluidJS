var Fluid=function(t){"use strict";function e(){}function s(){return"_"+Math.random().toString(36).substr(2,2)+Math.random().toString(36).substr(2,2)+Math.random().toString(36).substr(2,2)+Math.random().toString(36).substr(2,2)}var r={},n=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};return r.model=function(t){this.val=t,this.listeners=[]},r.model.prototype.get=function(){return this.val},r.model.prototype.set=function(t){return this.val=t,this.alert(),t},r.model.prototype.listen=function(t){this.listeners.push(t)},r.model.prototype.alert=function(){for(var t=0;t<this.listeners.length;t++)this.listeners[t]()},e.prototype.update=function(t){function s(t,e){l-=(new Date).getTime(),1==arguments.length?t.update():t.update(e),l+=(new Date).getTime()}if(this.state=(t||{}).state||this.state,!this.noMemoize&&(this.memoTime||0)<=(this.updateTime||0)/2){var r=(new Date).getTime(),o=JSON.stringify(this.state),i=o==this.oldStateHash,a=(new Date).getTime()-r;if(this.memoTime=(4*(this.memoTime||a)+a)/5,i)return;this.oldStateHash=o}else this.oldStateHash=void 0;var l=(new Date).getTime(),h=this.calc.apply(this,this.state),p=null!=this.vals;p||(this.$el=this.getFreshJQ(),this.vals={});for(var m in this.attrCommands)if(h.hasOwnProperty(m)){var f=h[m];if(!p||this.vals[m]!=f)for(var u in this.attrCommands[m]){var c=this.$el.is("["+u+"]")?this.$el:this.$el.find("["+u+"]");c.attr(this.attrCommands[m][u],f)}}for(var m in this.textCommands)if(h.hasOwnProperty(m)){var f=h[m];if(!p||this.vals[m]!=f)for(var v=this.textCommands[m],d=0;d<v.length;d++)(this.$el.is("["+v[d]+"]")?this.$el:this.$el.find("["+v[d]+"]")).text(f)}for(var m in this.viewCommands)if(h.hasOwnProperty(m)){var t=h[m],y=this.vals[m],c=this.$el.attr("id")==this.viewCommands[m]?this.$el:this.$el.find("#"+this.viewCommands[m]);if(n(t)){if(p)if(n(y)){for(var g=Math.min(t.length,y.length),d=0;g>d;d++)y[d].typeHash!=t[d].typeHash&&(g=d+1);for(;y.length>g;)y[y.length-1].$el.remove(),y.length--}else{if(y instanceof e)y.$el.remove();else if(y instanceof Object)for(var $ in y)y[$]instanceof e&&y[$].$el.remove();y=[]}else y=[];for(var d=0;d<y.length;d++)s(y[d],t[d]),t[d]=y[d];for(var d=y.length;d<t.length;d++)s(t[d]),c.before(t[d].$el)}else if(t instanceof e){var w=!0;if(p)if(n(y))for(var d=0;d<y.length;d++)y[d].$el.remove();else if(y instanceof e)y.typeHash!=t.typeHash?y.$el.remove():(w=!1,s(y,t),h[m]=y);else if(y instanceof Object)for(var $ in y)y[$]instanceof e&&y[$].$el.remove();w&&(s(t),c.before(t.$el))}else if(t instanceof Object){if(p){if(n(y)){for(var d=0;d<y.length;d++)y[d].$el.remove();y={}}else if(y instanceof e)y[d].$el.remove(),y={};else if(y instanceof Object)for(var C in y)t[C]instanceof e||t[C].typeHash==y[C].typeHash||(y[C].$el.remove(),y[C]=void 0)}else y={};var b=[];for(var $ in t)t[$]instanceof e&&b.push($);t.__SORT__&&(t.__SORT__ instanceof Function?b.sort(t.__SORT__):b.sort());for(var d=b.length-1;d>=0;d--){var $=b[d];void 0==y[$]?(s(t[$]),(d+1==b.length?c:t[b[d+1]].$el).before(t[$].$el)):(s(y[$],t[$]),t[$]=y[$])}}}this.vals=h,this.setControls.apply(this,[!p,this.$el].concat(this.state));var T=(new Date).getTime()-l;this.updateTime=(4*(this.updateTime||T)+T)/5},r.compileView=function(r){function n(){this.state=Array.prototype.slice.call(arguments,0)}return n.prototype=new e,n.prototype.calc=r.calc||function(){return new Object},n.prototype.setControls=r.setControls||function(){},n.prototype.noMemoize=!!r.noMemoize,n.prototype.typeHash=s(),n.prototype.attrCommands={},n.prototype.textCommands={},n.prototype.viewCommands={},r.template=r.template||"",r.template=r.template.replace(/[^\s]+={{\s*\w+\s*}}/g,function(t){var e=t.indexOf("="),r=t.substr(0,e),o=t.substr(e+3,t.length-e-5).trim(),i=s();return null==n.prototype.attrCommands[o]&&(n.prototype.attrCommands[o]={}),n.prototype.attrCommands[o][i]=r,i}).replace(/>\s*{{\s*\w+\s*}}\s*</g,function(t){var e=t.substr(1,t.length-2).trim();e=e.substr(2,e.length-4).trim();var r=s();return null==n.prototype.textCommands[e]&&(n.prototype.textCommands[e]=[]),n.prototype.textCommands[e].push(r)," "+r+"><"}).replace(/\[\[\s*\w+\s*\]\]/g,function(t){var e=t.substr(2,t.length-4).trim(),r=s();return n.prototype.viewCommands[e]=r,"<span id='"+r+"' style='display: none'></span>"}),n.prototype.getFreshJQ=function(){return t(r.template)},n},r.attachView=function(t,e){function s(){for(var t=[],s=0;s<n.length;s++)t.push(n[s].get());e.apply(this,t)}function r(){o.update(new s)}var n=Array.prototype.slice.call(arguments,2);s.prototype=e.prototype;var o=new s;o.update();for(var i=0;i<n.length;i++)n[i].listen(r);t.replaceWith(o.$el)},r}(jQuery);