var Fluid=function(t){"use strict";function e(t,e){return"function"==typeof Object.getPrototypeOf?Object.getPrototypeOf(t)==Object.getPrototypeOf(e):"object"==typeof"test".__proto__?t.__proto__==e.__proto__:t.constructor.prototype==e.constructor.prototype}function r(){}var o={},s=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};return o.model=function(t){this.val=t,this.listeners=[]},o.model.prototype.get=function(){return this.val},o.model.prototype.set=function(t){return this.val=t,this.alert(),t},o.model.prototype.listen=function(t){this.listeners.push(t)},o.model.prototype.alert=function(){for(var t=0;t<this.listeners.length;t++)this.listeners[t]()},r.prototype.update=function(t){if(this.state=(t||{}).state||this.state,!this.noMemoize){var r=JSON.stringify(this.state);if(r.length<500||r.length<5e3&&Array.prototype.filter.call(r,function(t){return'"'==t})<100){if(r==this.oldStateHash)return;this.oldStateHash=r}else this.noMemoize=!0,this.oldStateHash=void 0}var o=this.calc.apply(this,this.state),n=null!=this.vals;n||(this.$el=this.getFreshJQ(),this.vals={});for(var i in this.attrCommands)if(o.hasOwnProperty(i)){var a=o[i];if(!n||this.vals[i]!=a)for(var l in this.attrCommands[i]){var p=this.$el.is("["+l+"]")?this.$el:this.$el.find("["+l+"]");p.attr(this.attrCommands[i][l],a)}}for(var i in this.textCommands)if(o.hasOwnProperty(i)){var a=o[i];if(!n||this.vals[i]!=a)for(var h=this.textCommands[i],u=0;u<h.length;u++)(this.$el.is("["+h[u]+"]")?this.$el:this.$el.find("["+h[u]+"]")).text(a)}for(var i in this.viewCommands)if(o.hasOwnProperty(i)){var t=o[i],f=this.vals[i],p=this.$el.attr("id")==this.viewCommands[i]?this.$el:this.$el.find("#"+this.viewCommands[i]);if(s(t)){if(s(f)){var m=Math.min(t.length,f.length);for(m>0&&!e(f[0],t[0])&&(m=0);f.length>m;)f[f.length-1].$el.remove(),f.length--}else n&&f.$el.remove(),f=[];for(var u=0;u<f.length;u++)f[u].update(t[u]),t[u]=f[u];for(var u=f.length;u<t.length;u++)t[u].update(),p.before(t[u].$el)}else{var c=!0;if(n)if(s(f))for(var u=0;u<f.length;u++)f[u].$el.remove();else e(f,t)?(c=!1,f.update(t),o[i]=f):f.$el.remove();c&&(t.update(),p.before(t.$el))}}this.vals=o,this.setControls.apply(this,[!n,this.$el].concat(this.state))},o.compileView=function(e){function o(){this.state=Array.prototype.slice.call(arguments,0)}function s(){return"_"+Math.random().toString(36).substr(2)}return o.prototype=new r,o.prototype.calc=e.calc||function(){return new Object},o.prototype.setControls=e.setControls||function(){},o.prototype.attrCommands={},o.prototype.textCommands={},o.prototype.viewCommands={},e.template=e.template||"",e.template=e.template.replace(/[^\s]+={{\s*\w+\s*}}/g,function(t){var e=t.indexOf("="),r=t.substr(0,e),n=t.substr(e+3,t.length-e-5).trim(),i=s();return null==o.prototype.attrCommands[n]&&(o.prototype.attrCommands[n]={}),o.prototype.attrCommands[n][i]=r,i}).replace(/>\s*{{\s*\w+\s*}}\s*</g,function(t){var e=t.substr(1,t.length-2).trim();e=e.substr(2,e.length-4).trim();var r=s();return null==o.prototype.textCommands[e]&&(o.prototype.textCommands[e]=[]),o.prototype.textCommands[e].push(r)," "+r+"><"}).replace(/\[\[\s*\w+\s*\]\]/g,function(t){var e=t.substr(2,t.length-4).trim(),r=s();return o.prototype.viewCommands[e]=r,"<span id='"+r+"' style='display: none'></span>"}),o.prototype.getFreshJQ=function(){return t(e.template)},o},o.attachView=function(t,e){function r(){for(var t=[],r=0;r<s.length;r++)t.push(s[r].get());e.apply(this,t)}function o(){n.update(new r)}var s=Array.prototype.slice.call(arguments,2);r.prototype=e.prototype;var n=new r;n.update();for(var i=0;i<s.length;i++)s[i].listen(o);t.replaceWith(n.$el)},o}(jQuery);