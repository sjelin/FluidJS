!function(t,e){"object"==typeof module&&"object"==typeof module.exports?module.exports=t.document?e(t,t.jQuery||require("jquery")):function(){var t=require("jquery");return function(r){return e(r,r.jQuery||t(r))}}():t.Fluid=e(t,jQuery)}("undefined"!=typeof window?window:this,function(window,$){"use strict";function jqFind(t,e){return""==e?t:t.filter(e).add(t.find(e))}function model_get(){return this()}function model_set(t){return this(t)}function addValSyntax(t){if(Object.defineProperty)try{Object.defineProperty(t,"val",{get:model_get,set:t.set})}catch(e){}}function model_sub(t){var e=this,r=function(){return arguments.length>0?(e()[t]=arguments[0],e.alert(),arguments[0]):e()[t]};return $.extend(r,e),addValSyntax(r),r}function type_unformat(t){return((t||"")+"").split("").filter(function(t){return!this.formatChars(t)}.bind(this)).join("")}function type_reformat(t){return this.format(this.unformat(t))}function setCursorPos(t,e,r,a){if(t[0]instanceof window.HTMLInputElement||t[0]instanceof window.HTMLTextAreaElement)try{if(2==arguments.length&&(r=e),e=Math.min(e,r=Math.min(r,t.val().length)),elem.setSelectionRange)elem.setSelectionRange(e,r);else{var s=elem.createTextRange();s.collapse(!0),s.moveStart("character",e),s.moveEnd("character",r),s.select()}a&&(view.ctCursorPos[a]={s:e,e:r})}catch(n){}}function getTextSel(t){var e=t[0];if(e instanceof window.HTMLInputElement||e instanceof window.HTMLTextAreaElement)try{if(e.setSelectionRange)return{s:e.selectionStart,e:e.selectionEnd};var r=document.selection.createRange(),a=r.text.length;r.moveStart("character",-e.value.length);var s=r.text.length;return{s:s-a,e:s}}catch(n){}return{s:0,e:0}}function ctLogCursor(t,e,r){r.is(":focus")&&(t.ctCursorPos[e]=getTextSel(r))}function transIndex(t,e,r,a){var s,n=0;for(s=0;e>s;s++)t(r[s])||n++;for(s=0;s<a.length&&n>0;s++)t(a[s])||n--;for(;s<a.length&&t(a[s]);)s++;return s}function needsReformat(t,e,r,a){for(;r>0&&a(t[r-1]);)r--;if(t.slice(0,r)!=e.slice(0,r))return!0;for(t=t.slice(r);t.length>0&&a(t[0]);)t=t.slice(1);for(e=e.slice(r);e.length>0&&a(e[0]);)e=e.slice(1);return t!=e}function ctKeyListener(t,e,r){var a=r.val(),s=t.prevValues[e];if(a!=s){var n=t.ctMap[e],i=n.unformat(a);if(n.validate(i)){if(n.unformat(s)!=i)for(var o=t.ctListeners[e],l=0;l<o.length;l++)o[l](i);var f=n.format(i);if(needsReformat(r.val(),f,r.is(":focus")?getTextSel(r).s:r.val().length,n.formatChars)){var c=void 0;if(r.is(":focus")){var u=getTextSel(r);c={s:transIndex(n.formatChars,u.s,a,f),e:transIndex(n.formatChars,u.e,a,f)}}r.val(f),void 0!=c&&setCursorPos(r,c.s,c.e)}t.prevValues[e]=r.val()}else r.val(s),r.is(":focus")&&setCursorPos(r,t.ctCursorPos[e].s,t.ctCursorPos[e].e)}ctLogCursor(t,e,r)}function AbstractView(){}function isCheckable(t){var e=("INPUT"==t[0].tagName.toUpperCase()&&t.attr("type")||"").toUpperCase();return"CHECKBOX"==e||"RADIO"==e}function getValue(t){return isCheckable(t)?t[0].checked:t.val()}function setVal(t,e,r){if(isCheckable(e))e[0].checked=r;else{var a=e.attr(ctHashAttr);a&&(r=t.ctMap[a].reformat(r)),e.val()!=r&&(e.val(r),e.is(":focus")&&setCursorPos(e,r.length,a))}}function watch(t,e){function r(r){var a=t.listenTrgts[e]||[];isArray(a)||(a=[a]);for(var s=0;s<a.length;s++)a[s](r)}if(!t.prevValues.hasOwnProperty(e)){var a=jqFind(t.$el,e);if(a.is("["+ctHashAttr+"]"))t.prevValues[e]=void 0,t.ctListeners[a.attr(ctHashAttr)].push(r);else{t.prevValues[e]=getValue(a);var s=function(){var s=getValue(a);s!=t.prevValues[e]&&r(t.prevValues[e]=s)};a.on("input",s),a.keypress(s),a.keydown(s),a.keyup(s),a.change(s)}}}function rndStr(){return"_"+Math.random().toString(36).substr(2,6)+Math.random().toString(36).substr(2,6)}var fluid={},isArray=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};fluid.newModel=function(t){var e=[],r=function(){return arguments.length>0&&(t=arguments[0],r.alert()),t};return r.listen=e.push.bind(e),r.alert=function(){for(var t=0;t<e.length;t++)e[t]()},r.get=model_get,r.set=model_set,r.sub=model_sub,addValSyntax(r),r};var customTypes={},ctHashAttr="__fluid__custom_type_hash";return fluid.defineInputType=function(t,e){e=e||{};var r=void 0,a=e.typeAttr||t;isArray(a)||(a=[a]);for(var s=$("<input>"),n=0;!r&&n<a.length;n++)s.attr("type",a[n]).prop("type")==a[n]&&(r=a[n]);r||(r="text");for(var n=0;3>n;n++){var i=["validate","format","formatChars"][n];"object"!=typeof e[i]||e[i]instanceof RegExp||(e[i]=e[i][r])}var o=e.formatChars instanceof RegExp?e.formatChars.test.bind(e.formatChars):e.formatChars instanceof Function?e.formatChars:function(){return!1};return customTypes[t]={attr:r,validate:e.validate instanceof RegExp?e.validate.test.bind(e.validate):e.validate instanceof Function?e.validate:function(){return!0},format:e.format instanceof Function?e.format:function(t){return t},formatChars:o,unformat:type_unformat,reformat:type_reformat}},AbstractView.prototype.update=function(t){function e(t,e){i-=(new Date).getTime(),1==arguments.length?t.update():t.update(e),i+=(new Date).getTime()}if(this.state=(t||{}).state||this.state,!this.noMemoize&&(this.memoTime||0)<=(this.updateTime||0)/2){var r=(new Date).getTime(),a=JSON.stringify(this.state),s=a==this.oldStateHash,n=(new Date).getTime()-r;if(this.memoTime=(4*(this.memoTime||n)+n)/5,s)return;this.oldStateHash=a}else this.oldStateHash=void 0;var i=(new Date).getTime(),o=this.fill.apply(this,this.state),l=null!=this.vals;if(!l){this.$el=this.getFreshJQ(),this.vals={},this.prevValues={},this.ctListeners={},this.ctCursorPos={};for(var f in this.ctMap){var c=jqFind(this.$el,"["+ctHashAttr+'="'+f+'"]');this.prevValues[f]=c.val(),this.ctListeners[f]=[]}}for(var u in this.valCommands)if(o.hasOwnProperty(u))for(var p=o[u],h=this.valCommands[u],m=0;m<h.length;m++)setVal(this,jqFind(this.$el,"["+h[m]+"]"),p);for(var u in this.attrCommands)if(o.hasOwnProperty(u)){var p=o[u];if(!l||this.vals[u]!=p)for(var d in this.attrCommands[u]){var c=jqFind(this.$el,"["+d+"]");c.attr(this.attrCommands[u][d],p)}}for(var u in this.textCommands)if(o.hasOwnProperty(u)){var p=o[u];if(!l||this.vals[u]!=p)for(var v=this.textCommands[u],m=0;m<v.length;m++)jqFind(this.$el,"["+v[m]+"]").text(p)}for(var d in this.cmplxAttrCmds){for(var y=this.cmplxAttrCmds[d],p="",m=0;void 0!=p&&m<y.format.length;m++)m%2==0?p+=y.format[m]:o.hasOwnProperty(y.format[m])?p+=o[y.format[m]]:p=void 0;if(void 0!=p){var c=jqFind(this.$el,"["+d+"]");"VALUE"==y.attr.toUpperCase()?setVal(this,c,p):c.attr(y.attr,p)}}for(var u in this.viewCommands)if(o.hasOwnProperty(u)){var t=o[u],g=this.vals[u],c=jqFind(this.$el,"#"+this.viewCommands[u]);if(isArray(t)){if(l)if(isArray(g)){for(var w=Math.min(t.length,g.length),m=0;w>m;m++)g[m].typeHash!=t[m].typeHash&&(w=m);for(;g.length>w;)g[g.length-1].$el.remove(),g.length--}else{if(g instanceof AbstractView)g.$el.remove();else if(g instanceof Object)for(var C in g)g[C]instanceof AbstractView&&g[C].$el.remove();g=[]}else g=[];for(var m=0;m<g.length;m++)e(g[m],t[m]),t[m]=g[m];for(var m=g.length;m<t.length;m++)e(t[m]),c.before(t[m].$el)}else if(t instanceof AbstractView){var V=!0;if(l)if(isArray(g))for(var m=0;m<g.length;m++)g[m].$el.remove();else if(g instanceof AbstractView)g.typeHash!=t.typeHash?g.$el.remove():(V=!1,e(g,t),o[u]=g);else if(g instanceof Object)for(var C in g)g[C]instanceof AbstractView&&g[C].$el.remove();V&&(e(t),c.before(t.$el))}else if(t instanceof Object){if(l){if(isArray(g)){for(var m=0;m<g.length;m++)g[m].$el.remove();g={}}else if(g instanceof AbstractView)g.$el.remove(),g={};else if(g instanceof Object)for(var b in g)g[b]instanceof AbstractView?t[b]instanceof AbstractView&&t[b].typeHash==g[b].typeHash||(g[b].$el.remove(),g[b]=void 0):g[b]=void 0}else g={};var A=[];for(var C in t)t[C]instanceof AbstractView&&A.push(C);t.__SORT__&&(t.__SORT__ instanceof Function?A.sort(t.__SORT__):A.sort());for(var m=A.length-1;m>=0;m--){var C=A[m];void 0==g[C]?(e(t[C]),(m+1==A.length?c:t[A[m+1]].$el).before(t[C].$el)):(e(g[C],t[C]),t[C]=g[C])}}}this.vals=o,this.listenTrgts=this.listeners instanceof Function?this.listeners.apply(this,this.state):this.listeners;for(var x in this.listenTrgts)watch(this,x);l||this.addControls.apply(this,[this.$el].concat(this.state)),this.updateControls.apply(this,[l,this.$el].concat(this.state));var T=(new Date).getTime()-i;this.updateTime=(4*(this.updateTime||T)+T)/5},fluid.compileView=function(props){function View(){this.state=Array.prototype.slice.call(arguments,0)}props=props||{},View.prototype=new AbstractView,View.prototype.fill=props.fill||function(){return new Object},View.prototype.addControls=props.addControls||function(){},View.prototype.updateControls=props.updateControls||function(){},View.prototype.listeners=props.listeners||{},View.prototype.noMemoize=!!props.noMemoize,View.prototype.typeHash=rndStr(),View.prototype.valCommands={},View.prototype.attrCommands={},View.prototype.textCommands={},View.prototype.cmplxAttrCmds={},View.prototype.viewCommands={},View.prototype.ctMap={};var template=props.template||"";return template=template.replace(/[^\s]+=['"]{{\s*\w+\s*}}['"]/g,function(t){var e=t.lastIndexOf('"{{');return-1==e&&(e=t.lastIndexOf("'{{")),t.slice(0,e)+t.slice(e+1,-1)}).replace(/value={{\s*\w+\s*}}/g,function(t){var e=t.slice(8,-2).trim(),r=rndStr();return null==View.prototype.valCommands[e]&&(View.prototype.valCommands[e]=[]),View.prototype.valCommands[e].push(r),r}).replace(/[^\s]+={{\s*\w+\s*}}/g,function(t){var e=t.lastIndexOf("="),r=t.slice(0,e),a=t.slice(e+3,-2).trim(),s=rndStr();return null==View.prototype.attrCommands[a]&&(View.prototype.attrCommands[a]={}),View.prototype.attrCommands[a][s]=r,s}).replace(/>\s*{{\s*\w+\s*}}\s*</g,function(t){var e=t.slice(1,-1).trim().slice(2,-2).trim(),r=rndStr();return null==View.prototype.textCommands[e]&&(View.prototype.textCommands[e]=[]),View.prototype.textCommands[e].push(r)," "+r+"><"}).replace(/[^\s]+=(?:"[^"]*?{{\s*\w+\s*}}(?:[^"]*?[^\\])?"|'[^']*?{{\s*\w+\s*}}(?:[^']*?[^\\])?')/g,function(match){var i=match.indexOf("="),attr=match.substr(0,i),q=match.substr(i+1,1),format=match.slice(i+2,-1).split(/{{|}}/);for(i=0;i<format.length;i+=2)format[i]=eval(q+format[i]+q);var id=rndStr();return View.prototype.cmplxAttrCmds[id]={attr:attr,format:format},id}).replace(/\[\[\s*\w+\s*\]\]/g,function(t){var e=t.slice(2,-2).trim(),r=rndStr();return View.prototype.viewCommands[e]=r,"<span id='"+r+"' style='display: none'></span>"}).replace(/type=["']\s*\w*\s*["']/g,function(t){var e=t.slice(6,-1).trim();if(customTypes[e]){var r=customTypes[e],a=rndStr();View.prototype.ctMap[a]=r;var s=t.slice(-1);return ctHashAttr+"="+s+a+s+" type="+s+r.attr+s}return t}),View.prototype.getFreshJQ=function(){var t=$(template);for(var e in this.ctMap){var r=jqFind(t,"["+ctHashAttr+"='"+e+"']");r.val(this.ctMap[e].reformat(r.val()));var a=ctKeyListener.bind(null,this,e,r),s=ctLogCursor.bind(null,this,e,r);r.on("input",a),r.keypress(a),r.keydown(a),r.keyup(a),r.change(a),r.click(s),r.mouseup(s),r.mousedown(s),r.focus(s)}return t},View},fluid.attachView=function(t,e){function r(){for(var t=[],r=0;r<s.length;r++)t.push(s[r].get());e.apply(this,t)}function a(){n.update(new r)}var s=Array.prototype.slice.call(arguments,2);r.prototype=e.prototype;var n=new r;n.update();for(var i=0;i<s.length;i++)s[i].listen(a);t.replaceWith(n.$el)},fluid});