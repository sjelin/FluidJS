!function(t,e){"object"==typeof module&&"object"==typeof module.exports?module.exports=t.document?e(t,t.jQuery||require("jquery")):function(){var t=require("jquery");return function(r){return e(r,r.jQuery||t(r))}}():t.Fluid=e(t,jQuery)}("undefined"!=typeof window?window:this,function(t,e){"use strict";function r(t,e){return""==e?t:t.filter(e).add(t.find(e))}function n(){return this()}function a(t){return this(t)}function s(t){if(Object.defineProperty)try{Object.defineProperty(t,"val",{get:n,set:t.set})}catch(e){}}function o(t){var r=this,n=function(){return arguments.length>0?(r()[t]=arguments[0],r.alert(),arguments[0]):r()[t]};return e.extend(n,r),s(n),n}function i(t){return(t||"").split("").filter(this.valChars).join("")}function l(t){return this.format(this.unformat(t))}function f(e,r,n,a){if(e[0]instanceof t.HTMLInputElement||e[0]instanceof t.HTMLTextAreaElement)try{if(2==arguments.length&&(n=r),r=Math.min(r,n=Math.min(n,e.val().length)),elem.setSelectionRange)elem.setSelectionRange(r,n);else{var s=elem.createTextRange();s.collapse(!0),s.moveStart("character",r),s.moveEnd("character",n),s.select()}a&&(view.ctCursorPos[a]={s:r,e:n})}catch(o){}}function u(e){var r=e[0];if(r instanceof t.HTMLInputElement||r instanceof t.HTMLTextAreaElement)try{if(r.setSelectionRange)return{s:r.selectionStart,e:r.selectionEnd};var n=document.selection.createRange(),a=n.text.length;n.moveStart("character",-r.value.length);var s=n.text.length;return{s:s-a,e:s}}catch(o){}return{s:0,e:0}}function h(t,e,r){r.is(":focus")&&(t.ctCursorPos[e]=u(r))}function c(t,e,r,n){var a,s=0;for(a=0;e>a;a++)t(r[a])&&s++;for(a=0;a<n.length&&s>0;a++)t(n[a])&&s--;for(;a<n.length&&!t(n[a]);)a++;return a}function p(t,e,r){var n=r.val(),a=t.prevValues[e];if(n!=a){var s=t.ctMap[e],o=s.unformat(n);if(s.validate(o)){if(s.unformat(a)!=o)for(var i=t.ctListeners[e],l=0;l<i.length;l++)i[l](o);var p=s.format(o);if(r.val()!=p){var v=void 0;if(r.is(":focus")){var m=u(r);v={s:c(s.valChars,m.s,n,p),e:c(s.valChars,m.e,n,p)}}r.val(p),void 0!=v&&f(r,v.s,v.e)}t.prevValues[e]=r.val()}else r.val(a),r.is(":focus")&&f(r,t.ctCursorPos[e].s,t.ctCursorPos[e].e)}h(t,e,r)}function v(){}function m(t,e){function n(r){var n=t.listenTrgts[e]||[];g(n)||(n=[n]);for(var a=0;a<n.length;a++)n[a](r)}if(!t.prevValues.hasOwnProperty(e)){var a=r(t.$el,e);if(a.is("["+w+"]"))t.prevValues[e]=void 0,t.ctListeners[a.attr(w)].push(n);else{t.prevValues[e]=a.val();var s=function(){var r=a.val();r!=t.prevValues[e]&&n(t.prevValues[e]=r)};a.keypress(s),a.keydown(s),a.keyup(s),a.change(s)}}}function d(){return"_"+Math.random().toString(36).substr(2,6)+Math.random().toString(36).substr(2,6)}var y={},g=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};y.newModel=function(t){var e=[],r=function(){return arguments.length>0&&(t=arguments[0],r.alert()),t};return r.listen=e.push.bind(e),r.alert=function(){for(var t=0;t<e.length;t++)e[t]()},r.get=n,r.set=a,r.sub=o,s(r),r};var C={},w="__fluid__custom_type_hash";return y.defineType=function(t,r){r=r||{};var n=void 0,a=r.typeAttr||t;g(a)||(a=[a]);for(var s=e("<input>"),o=0;!n&&o<a.length;o++)s.attr("type",a[o]).prop("type")==a[o]&&(n=a[o]);n||(n="text");for(var o=0;3>o;o++){var f=["validate","format","valChars"][o];"object"!=typeof r[f]||r[f]instanceof RegExp||(r[f]=r[f][n])}var u=r.valChars instanceof RegExp?r.valChars.test.bind(r.valChars):r.valChars instanceof Function?r.valChars:function(){return!0};return C[t]={attr:n,validate:r.validate instanceof RegExp?r.validate.test.bind(r.validate):r.validate instanceof Function?r.validate:function(){return!0},format:r.format instanceof Function?r.format:function(t){return t},valChars:u,unformat:i,reformat:l}},v.prototype.update=function(t){function e(t,e){i-=(new Date).getTime(),1==arguments.length?t.update():t.update(e),i+=(new Date).getTime()}if(this.state=(t||{}).state||this.state,!this.noMemoize&&(this.memoTime||0)<=(this.updateTime||0)/2){var n=(new Date).getTime(),a=JSON.stringify(this.state),s=a==this.oldStateHash,o=(new Date).getTime()-n;if(this.memoTime=(4*(this.memoTime||o)+o)/5,s)return;this.oldStateHash=a}else this.oldStateHash=void 0;var i=(new Date).getTime(),l=this.fill.apply(this,this.state),u=null!=this.vals;if(!u){this.$el=this.getFreshJQ(),this.vals={},this.prevValues={},this.ctListeners={},this.ctCursorPos={};for(var h in this.ctMap){var c=r(this.$el,"["+w+'="'+h+'"]');this.prevValues[h]=c.val(),this.ctListeners[h]=[]}}for(var p in this.valCommands)if(l.hasOwnProperty(p))for(var d=l[p],y=this.valCommands[p],C=0;C<y.length;C++){var c=r(this.$el,"["+y[C]+"]"),b=d,T=c.attr(w);T&&(b=this.ctMap[T].reformat(b)),c.val()!=b&&(c.val(b),c.is(":focus")&&f(c,b.length,T))}for(var p in this.attrCommands)if(l.hasOwnProperty(p)){var d=l[p];if(!u||this.vals[p]!=d)for(var $ in this.attrCommands[p]){var c=r(this.$el,"["+$+"]");c.attr(this.attrCommands[p][$],d)}}for(var p in this.textCommands)if(l.hasOwnProperty(p)){var d=l[p];if(!u||this.vals[p]!=d)for(var x=this.textCommands[p],C=0;C<x.length;C++)r(this.$el,"["+x[C]+"]").text(d)}for(var p in this.viewCommands)if(l.hasOwnProperty(p)){var t=l[p],M=this.vals[p],c=r(this.$el,"#"+this.viewCommands[p]);if(g(t)){if(u)if(g(M)){for(var _=Math.min(t.length,M.length),C=0;_>C;C++)M[C].typeHash!=t[C].typeHash&&(_=C);for(;M.length>_;)M[M.length-1].$el.remove(),M.length--}else{if(M instanceof v)M.$el.remove();else if(M instanceof Object)for(var j in M)M[j]instanceof v&&M[j].$el.remove();M=[]}else M=[];for(var C=0;C<M.length;C++)e(M[C],t[C]),t[C]=M[C];for(var C=M.length;C<t.length;C++)e(t[C]),c.before(t[C].$el)}else if(t instanceof v){var O=!0;if(u)if(g(M))for(var C=0;C<M.length;C++)M[C].$el.remove();else if(M instanceof v)M.typeHash!=t.typeHash?M.$el.remove():(O=!1,e(M,t),l[p]=M);else if(M instanceof Object)for(var j in M)M[j]instanceof v&&M[j].$el.remove();O&&(e(t),c.before(t.$el))}else if(t instanceof Object){if(u){if(g(M)){for(var C=0;C<M.length;C++)M[C].$el.remove();M={}}else if(M instanceof v)M.$el.remove(),M={};else if(M instanceof Object)for(var S in M)M[S]instanceof v?t[S]instanceof v&&t[S].typeHash==M[S].typeHash||(M[S].$el.remove(),M[S]=void 0):M[S]=void 0}else M={};var H=[];for(var j in t)t[j]instanceof v&&H.push(j);t.__SORT__&&(t.__SORT__ instanceof Function?H.sort(t.__SORT__):H.sort());for(var C=H.length-1;C>=0;C--){var j=H[C];void 0==M[j]?(e(t[j]),(C+1==H.length?c:t[H[C+1]].$el).before(t[j].$el)):(e(M[j],t[j]),t[j]=M[j])}}}this.vals=l,this.listenTrgts=this.listeners instanceof Function?this.listeners.apply(this,this.state):this.listeners;for(var P in this.listenTrgts)m(this,P);u||this.addControls.apply(this,[this.$el].concat(this.state)),this.updateControls.apply(this,[u,this.$el].concat(this.state));var R=(new Date).getTime()-i;this.updateTime=(4*(this.updateTime||R)+R)/5},y.compileView=function(t){function n(){this.state=Array.prototype.slice.call(arguments,0)}t=t||{},n.prototype=new v,n.prototype.fill=t.fill||function(){return new Object},n.prototype.addControls=t.addControls||function(){},n.prototype.updateControls=t.updateControls||function(){},n.prototype.listeners=t.listeners||{},n.prototype.noMemoize=!!t.noMemoize,n.prototype.typeHash=d(),n.prototype.valCommands={},n.prototype.attrCommands={},n.prototype.textCommands={},n.prototype.viewCommands={},n.prototype.ctMap={};var a=t.template||"";return a=a.replace(/value={{\s*\w+\s*}}/g,function(t){var e=t.substr(8,t.length-10).trim(),r=d();return null==n.prototype.valCommands[e]&&(n.prototype.valCommands[e]=[]),n.prototype.valCommands[e].push(r),r}).replace(/[^\s]+={{\s*\w+\s*}}/g,function(t){var e=t.indexOf("="),r=t.substr(0,e),a=t.substr(e+3,t.length-e-5).trim(),s=d();return null==n.prototype.attrCommands[a]&&(n.prototype.attrCommands[a]={}),n.prototype.attrCommands[a][s]=r,s}).replace(/>\s*{{\s*\w+\s*}}\s*</g,function(t){var e=t.substr(1,t.length-2).trim();e=e.substr(2,e.length-4).trim();var r=d();return null==n.prototype.textCommands[e]&&(n.prototype.textCommands[e]=[]),n.prototype.textCommands[e].push(r)," "+r+"><"}).replace(/\[\[\s*\w+\s*\]\]/g,function(t){var e=t.substr(2,t.length-4).trim(),r=d();return n.prototype.viewCommands[e]=r,"<span id='"+r+"' style='display: none'></span>"}).replace(/type=["']\s*\w*\s*["']/g,function(t){var e=t.substr(6,t.length-7).trim();if(C[e]){var r=C[e],a=d();n.prototype.ctMap[a]=r;var s=t.slice(-1);return w+"="+s+a+s+" type="+s+r.attr+s}return t}),n.prototype.getFreshJQ=function(){var t=e(a);for(var n in this.ctMap){var s=r(t,"["+w+"='"+n+"']");s.val(this.ctMap[n].reformat(s.val()));var o=p.bind(null,this,n,s),i=h.bind(null,this,n,s);s.keypress(o),s.keydown(o),s.keyup(o),s.change(o),s.click(i),s.mouseup(i),s.mousedown(i),s.focus(i)}return t},n},y.attachView=function(t,e){function r(){for(var t=[],r=0;r<a.length;r++)t.push(a[r].get());e.apply(this,t)}function n(){s.update(new r)}var a=Array.prototype.slice.call(arguments,2);r.prototype=e.prototype;var s=new r;s.update();for(var o=0;o<a.length;o++)a[o].listen(n);t.replaceWith(s.$el)},y});